<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RGB LED Controller</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg: #0a0a0a;
            --card: #1a1a1a;
            --card-hover: #222;
            --primary: #00a8ff;
            --success: #00d68f;
            --error: #ff3838;
            --text: #ffffff;
            --text-dim: #888;
            --border: #333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #00a8ff, #00d68f);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 14px;
            color: var(--text-dim);
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--error);
            transition: all 0.3s;
        }

        .dot.connected {
            background: var(--success);
            box-shadow: 0 0 15px var(--success);
        }

        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text);
        }

        button {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:active { transform: scale(0.98); opacity: 0.9; }

        .btn-power {
            background: var(--card-hover);
            color: var(--text);
            margin-bottom: 8px;
        }

        .btn-power.on {
            background: var(--success);
            color: white;
        }

        .btn-power:active { transform: scale(0.98); }

        .mode-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .mode-btn {
            padding: 14px;
            background: var(--card-hover);
            border: 2px solid transparent;
            border-radius: 10px;
            color: var(--text-dim);
            font-size: 14px;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .mode-btn:active { transform: scale(0.96); }

        .slider-container {
            margin-bottom: 20px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-dim);
        }

        .slider-value {
            color: var(--primary);
            font-weight: 600;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--card-hover);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,168,255,0.4);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: none;
        }

        .color-input {
            width: 100%;
            height: 60px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 16px;
        }

        .effects-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .effect-btn {
            padding: 12px 8px;
            background: var(--card-hover);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-dim);
            font-size: 12px;
            transition: all 0.2s;
        }

        .effect-btn:active {
            transform: scale(0.95);
            background: var(--primary);
            color: white;
        }

        .hidden { display: none; }

        #log {
            background: #000;
            color: #0f0;
            padding: 12px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #222;
        }

        .warning {
            background: rgba(255, 56, 56, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
            padding: 12px;
            border-radius: 10px;
            font-size: 13px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>RGB LED Controller</h1>
        <div class="status">
            <div id="statusDot" class="dot"></div>
            <span id="statusText">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
        </div>
    </div>

    <div id="bleWarning" class="warning hidden">
        ‚ö†Ô∏è Bluetooth –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Bluefy –Ω–∞ iOS —Å HTTPS.
    </div>

    <div class="card">
        <button id="connectBtn" class="btn-primary">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ ELK-BLEDOB</button>
    </div>

    <div id="controls" class="hidden">
        <!-- Power -->
        <div class="card">
            <button id="powerBtn" class="btn-power">–í–∫–ª—é—á–∏—Ç—å</button>
        </div>

        <!-- Modes -->
        <div class="card">
            <div class="card-title">–†–µ–∂–∏–º—ã</div>
            <div class="mode-grid">
                <button class="mode-btn" data-mode="rgb">RGB</button>
                <button class="mode-btn" data-mode="grayscale">–ë–µ–ª—ã–π</button>
                <button class="mode-btn" data-mode="temperature">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</button>
                <button class="mode-btn" data-mode="effect">–≠—Ñ—Ñ–µ–∫—Ç—ã</button>
            </div>
        </div>

        <!-- RGB Mode -->
        <div id="rgbMode" class="card hidden">
            <div class="card-title">RGB –¶–≤–µ—Ç</div>
            <input type="color" id="colorPicker" class="color-input" value="#ff0000">
            <div class="slider-container">
                <div class="slider-label">
                    <span>–Ø—Ä–∫–æ—Å—Ç—å</span>
                    <span class="slider-value"><span id="brightnessVal">100</span>%</span>
                </div>
                <input type="range" id="brightness" min="0" max="100" value="100">
            </div>
        </div>

        <!-- Grayscale Mode -->
        <div id="grayscaleMode" class="card hidden">
            <div class="card-title">–ë–µ–ª—ã–π —Å–≤–µ—Ç</div>
            <div class="slider-container">
                <div class="slider-label">
                    <span>–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å</span>
                    <span class="slider-value"><span id="grayscaleVal">100</span>%</span>
                </div>
                <input type="range" id="grayscale" min="0" max="100" value="100">
            </div>
        </div>

        <!-- Temperature Mode -->
        <div id="temperatureMode" class="card hidden">
            <div class="card-title">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Å–≤–µ—Ç–∞</div>
            <div class="slider-container">
                <div class="slider-label">
                    <span>–•–æ–ª–æ–¥–Ω—ã–π</span>
                    <span>–¢—ë–ø–ª—ã–π</span>
                </div>
                <input type="range" id="temperature" min="128" max="138" value="133">
            </div>
            <div class="slider-container">
                <div class="slider-label">
                    <span>–Ø—Ä–∫–æ—Å—Ç—å</span>
                    <span class="slider-value"><span id="tempBrightnessVal">100</span>%</span>
                </div>
                <input type="range" id="tempBrightness" min="0" max="100" value="100">
            </div>
        </div>

        <!-- Effect Mode -->
        <div id="effectMode" class="card hidden">
            <div class="card-title">–≠—Ñ—Ñ–µ–∫—Ç—ã</div>
            <div class="effects-grid">
                <button class="effect-btn" data-effect="fire" style="background: linear-gradient(135deg, #ff4500, #ffa500); color: white; font-weight: bold;">üî• –û–≥–æ–Ω—å</button>
                <button class="effect-btn" data-effect="0x96">Blink Red</button>
                <button class="effect-btn" data-effect="0x87">Jump RGB</button>
                <button class="effect-btn" data-effect="0x88">Jump All</button>
                <button class="effect-btn" data-effect="0x89">Gradient RGB</button>
                <button class="effect-btn" data-effect="0x8a">Gradient All</button>
                <button class="effect-btn" data-effect="0x95">Blink All</button>
                <button class="effect-btn" data-effect="0x80">Red</button>
                <button class="effect-btn" data-effect="0x81">Green</button>
                <button class="effect-btn" data-effect="0x82">Blue</button>
                <button class="effect-btn" data-effect="0x83">Yellow</button>
                <button class="effect-btn" data-effect="0x84">Cyan</button>
                <button class="effect-btn" data-effect="0x85">Magenta</button>
                <button class="effect-btn" data-effect="0x86">White</button>
            </div>
            <div class="slider-container" style="margin-top: 16px;">
                <div class="slider-label">
                    <span>–°–∫–æ—Ä–æ—Å—Ç—å</span>
                    <span class="slider-value"><span id="speedVal">50</span>%</span>
                </div>
                <input type="range" id="speed" min="0" max="100" value="50">
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-title">–õ–æ–≥</div>
        <div id="log">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</div>
    </div>
</div>

<script>
    const SERVICE_UUID = 0xFFF0;
    const CHAR_UUID_MAIN = 'c6fe3e34-f194-4e8a-b1df-c7debbe0e061';
    const CHAR_UUID_FALLBACK = 0xFFF3;

    let device = null;
    let characteristic = null;
    let isPowerOn = false;
    let currentMode = 'rgb';
    let fireInterval = null;

    const $ = id => document.getElementById(id);
    const log = msg => {
        const time = new Date().toLocaleTimeString('ru-RU');
        $('log').innerHTML += `[${time}] ${msg}<br>`;
        $('log').scrollTop = $('log').scrollHeight;
    };

    if (!navigator.bluetooth) {
        $('bleWarning').classList.remove('hidden');
        log("‚ö†Ô∏è Bluetooth API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
    }

    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    $('connectBtn').onclick = async () => {
        try {
            log("–ü–æ–∏—Å–∫ ELK-BLEDOB...");
            device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'ELK' }]
            });

            log(`–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ "${device.name}"...`);
            device.addEventListener('gattserverdisconnected', onDisconnect);

            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(SERVICE_UUID);

            try {
                characteristic = await service.getCharacteristic(CHAR_UUID_MAIN.toLowerCase());
            } catch {
                characteristic = await service.getCharacteristic(CHAR_UUID_FALLBACK);
            }

            $('statusDot').classList.add('connected');
            $('statusText').innerText = `–ü–æ–¥–∫–ª—é—á–µ–Ω–æ: ${device.name}`;
            $('connectBtn').innerText = '–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å';
            $('controls').classList.remove('hidden');
            log("‚úì –ì–æ—Ç–æ–≤–æ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é");

        } catch (err) {
            log(`‚úó –û—à–∏–±–∫–∞: ${err.message}`);
        }
    };

    function onDisconnect() {
        log("‚úó –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ");
        $('statusDot').classList.remove('connected');
        $('statusText').innerText = '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
        $('controls').classList.add('hidden');
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã
    async function send(hex) {
        if (!characteristic) return log("‚úó –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
        try {
            const bytes = new Uint8Array(hex.match(/.{2}/g).map(b => parseInt(b, 16)));
            await characteristic.writeValue(bytes);
            log(`‚Üí ${hex}`);
        } catch (err) {
            log(`‚úó ${err.message}`);
        }
    }

    // Power
    $('powerBtn').onclick = () => {
        isPowerOn = !isPowerOn;
        send(isPowerOn ? '7e00040100000000ef' : '7e00040000000000ef');
        $('powerBtn').textContent = isPowerOn ? '–í—ã–∫–ª—é—á–∏—Ç—å' : '–í–∫–ª—é—á–∏—Ç—å';
        $('powerBtn').classList.toggle('on', isPowerOn);
    };

    // –†–µ–∂–∏–º—ã
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            const mode = btn.dataset.mode;
            currentMode = mode;

            ['rgbMode', 'grayscaleMode', 'temperatureMode', 'effectMode'].forEach(id => {
                $(id).classList.add('hidden');
            });

            if (mode === 'rgb') {
                $('rgbMode').classList.remove('hidden');
                updateRGB();
            } else if (mode === 'grayscale') {
                $('grayscaleMode').classList.remove('hidden');
                send('7e00030001000000ef');
                updateGrayscale();
            } else if (mode === 'temperature') {
                $('temperatureMode').classList.remove('hidden');
                updateTemperature();
            } else if (mode === 'effect') {
                $('effectMode').classList.remove('hidden');
            }
        };
    });

    // RGB Mode
    function updateRGB() {
        const color = $('colorPicker').value;
        const r = parseInt(color.substr(1, 2), 16);
        const g = parseInt(color.substr(3, 2), 16);
        const b = parseInt(color.substr(5, 2), 16);
        
        const rHex = r.toString(16).padStart(2, '0');
        const gHex = g.toString(16).padStart(2, '0');
        const bHex = b.toString(16).padStart(2, '0');
        
        send(`7e000503${rHex}${gHex}${bHex}00ef`);
    }

    $('colorPicker').oninput = updateRGB;

    $('brightness').oninput = function() {
        $('brightnessVal').textContent = this.value;
        const val = parseInt(this.value).toString(16).padStart(2, '0');
        send(`7e0001${val}00000000ef`);
    };

    // Grayscale Mode
    $('grayscale').oninput = function() {
        $('grayscaleVal').textContent = this.value;
        updateGrayscale();
    };

    function updateGrayscale() {
        const val = parseInt($('grayscale').value).toString(16).padStart(2, '0');
        send(`7e000501${val}000000ef`);
    }

    // Temperature Mode
    $('temperature').oninput = function() {
        const val = parseInt(this.value).toString(16).padStart(2, '0');
        send(`7e0003${val}02000000ef`);
    };

    $('tempBrightness').oninput = function() {
        $('tempBrightnessVal').textContent = this.value;
        const val = parseInt(this.value).toString(16).padStart(2, '0');
        send(`7e0001${val}00000000ef`);
    };

    // Effects
    document.querySelectorAll('.effect-btn').forEach(btn => {
        btn.onclick = () => {
            const effect = btn.dataset.effect;
            
            // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –æ–≥–Ω—è, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –∑–∞–ø—É—â–µ–Ω
            if (fireInterval) {
                clearInterval(fireInterval);
                fireInterval = null;
            }
            
            if (effect === 'fire') {
                // –ö–∞—Å—Ç–æ–º–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –æ–≥–Ω—è
                log("üî• –ó–∞–ø—É—â–µ–Ω —ç—Ñ—Ñ–µ–∫—Ç –æ–≥–Ω—è");
                
                const fireColors = [
                    { r: 255, g: 40, b: 0 },   // –ö—Ä–∞—Å–Ω—ã–π
                    { r: 255, g: 80, b: 0 },   // –ö—Ä–∞—Å–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π
                    { r: 255, g: 120, b: 0 },  // –û—Ä–∞–Ω–∂–µ–≤—ã–π
                    { r: 255, g: 160, b: 0 },  // –ñ—ë–ª—Ç–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π
                    { r: 255, g: 200, b: 0 },  // –ñ—ë–ª—Ç—ã–π
                ];
                
                fireInterval = setInterval(() => {
                    // –°–ª—É—á–∞–π–Ω—ã–π —Ü–≤–µ—Ç –∏–∑ –ø–∞–ª–∏—Ç—Ä—ã
                    const color = fireColors[Math.floor(Math.random() * fireColors.length)];
                    // –°–ª—É—á–∞–π–Ω–∞—è —è—Ä–∫–æ—Å—Ç—å (80-100%)
                    const brightness = Math.floor(Math.random() * 21) + 80;
                    
                    const rHex = Math.floor(color.r * brightness / 100).toString(16).padStart(2, '0');
                    const gHex = Math.floor(color.g * brightness / 100).toString(16).padStart(2, '0');
                    const bHex = Math.floor(color.b * brightness / 100).toString(16).padStart(2, '0');
                    
                    send(`7e000503${rHex}${gHex}${bHex}00ef`);
                }, 100 + Math.random() * 100); // –°–ª—É—á–∞–π–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 100-200ms
                
            } else {
                // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
                const effectHex = parseInt(effect).toString(16).padStart(2, '0');
                send(`7e0003${effectHex}03000000ef`);
            }
        };
    });

    $('speed').oninput = function() {
        $('speedVal').textContent = this.value;
        const val = parseInt(this.value).toString(16).padStart(2, '0');
        send(`7e0002${val}00000000ef`);
    };

    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º RGB –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    document.querySelector('.mode-btn[data-mode="rgb"]').click();
</script>

</body>
</html>
