<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RGB LED Controller</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg: #0a0a0a;
            --card: #1a1a1a;
            --card-hover: #222;
            --primary: #00a8ff;
            --success: #00d68f;
            --error: #ff3838;
            --text: #ffffff;
            --text-dim: #888;
            --border: #333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #00a8ff, #00d68f);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 14px;
            color: var(--text-dim);
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--error);
            transition: all 0.3s;
        }

        .dot.connected {
            background: var(--success);
            box-shadow: 0 0 15px var(--success);
        }

        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text);
        }

        button {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:active { transform: scale(0.98); opacity: 0.9; }

        .btn-disconnect {
            background: var(--error);
            color: white;
            margin-top: 8px;
        }

        .btn-disconnect:active { transform: scale(0.98); opacity: 0.9; }

        .btn-power {
            background: var(--card-hover);
            color: var(--text);
            margin-bottom: 8px;
        }

        .btn-power.on {
            background: var(--success);
            color: white;
        }

        .btn-power:active { transform: scale(0.98); }

        .slider-container {
            margin-bottom: 20px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-dim);
        }

        .slider-value {
            color: var(--primary);
            font-weight: 600;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--card-hover);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,168,255,0.4);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: none;
        }

        .color-input {
            width: 100%;
            height: 60px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 16px;
        }

        .hidden { display: none; }

        #log {
            background: #000;
            color: #0f0;
            padding: 12px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #222;
        }

        .warning {
            background: rgba(255, 56, 56, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
            padding: 12px;
            border-radius: 10px;
            font-size: 13px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Block Lamp Controller</h1>
        <div class="status">
            <div id="statusDot" class="dot"></div>
            <span id="statusText">Not connected</span>
        </div>
    </div>

    <div id="bleWarning" class="warning hidden">
        ⚠️ Bluetooth unavailable. Use Bluefy browser on iOS with HTTPS.
    </div>

    <div class="card">
        <button id="connectBtn" class="btn-primary">Connect to Block Lamp</button>
        <button id="disconnectBtn" class="btn-disconnect hidden">Disconnect</button>
    </div>

    <div id="controls" class="hidden">
        <!-- Power -->
        <div class="card">
            <button id="powerBtn" class="btn-power">Turn On</button>
        </div>

        <!-- RGB Mode -->
        <div class="card">
            <div class="card-title">RGB Color</div>
            <input type="color" id="colorPicker" class="color-input" value="#ff0000">
            <div class="slider-container">
                <div class="slider-label">
                    <span>Brightness</span>
                    <span class="slider-value"><span id="brightnessVal">100</span>%</span>
                </div>
                <input type="range" id="brightness" min="0" max="100" value="100">
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-title">Log</div>
        <div id="log">Waiting for connection...</div>
    </div>
</div>

<script>
    const SERVICE_UUID = 0xFFF0;
    const CHAR_UUID_MAIN = 'c6fe3e34-f194-4e8a-b1df-c7debbe0e061';
    const CHAR_UUID_FALLBACK = 0xFFF3;

    let device = null;
    let characteristic = null;
    let isPowerOn = false;

    const $ = id => document.getElementById(id);
    const log = msg => {
        const time = new Date().toLocaleTimeString('en-US');
        $('log').innerHTML += `[${time}] ${msg}<br>`;
        $('log').scrollTop = $('log').scrollHeight;
    };

    if (!navigator.bluetooth) {
        $('bleWarning').classList.remove('hidden');
        log("⚠️ Bluetooth API unavailable");
    }

    // Connect
    $('connectBtn').onclick = async () => {
        try {
            log("Searching for Block Lamp...");
            device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'ELK' }],
                optionalServices: [SERVICE_UUID]
            });

            log(`Connecting to "${device.name}"...`);
            device.addEventListener('gattserverdisconnected', onDisconnect);

            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(SERVICE_UUID);

            try {
                characteristic = await service.getCharacteristic(CHAR_UUID_MAIN.toLowerCase());
            } catch {
                characteristic = await service.getCharacteristic(CHAR_UUID_FALLBACK);
            }

            $('statusDot').classList.add('connected');
            $('statusText').innerText = `Connected: ${device.name}`;
            $('connectBtn').classList.add('hidden');
            $('disconnectBtn').classList.remove('hidden');
            $('controls').classList.remove('hidden');
            log("✓ Ready to control");

        } catch (err) {
            log(`✗ Error: ${err.message}`);
        }
    };

    function onDisconnect() {
        log("✗ Device disconnected");
        $('statusDot').classList.remove('connected');
        $('statusText').innerText = 'Not connected';
        $('controls').classList.add('hidden');
        $('connectBtn').classList.remove('hidden');
        $('disconnectBtn').classList.add('hidden');
        
        device = null;
        characteristic = null;
    }

    // Disconnect button
    $('disconnectBtn').onclick = () => {
        if (device && device.gatt.connected) {
            log("Disconnecting from device...");
            device.gatt.disconnect();
        }
    };

    // Send command
    async function send(hex) {
        if (!characteristic) return log("✗ No connection");
        try {
            const bytes = new Uint8Array(hex.match(/.{2}/g).map(b => parseInt(b, 16)));
            await characteristic.writeValue(bytes);
            log(`→ ${hex}`);
        } catch (err) {
            log(`✗ ${err.message}`);
        }
    }

    // Power
    $('powerBtn').onclick = () => {
        isPowerOn = !isPowerOn;
        send(isPowerOn ? '7e00040100000000ef' : '7e00040000000000ef');
        $('powerBtn').textContent = isPowerOn ? 'Turn Off' : 'Turn On';
        $('powerBtn').classList.toggle('on', isPowerOn);
    };

    // RGB Mode
    function updateRGB() {
        const color = $('colorPicker').value;
        const r = parseInt(color.substr(1, 2), 16);
        const g = parseInt(color.substr(3, 2), 16);
        const b = parseInt(color.substr(5, 2), 16);
        
        const rHex = r.toString(16).padStart(2, '0');
        const gHex = g.toString(16).padStart(2, '0');
        const bHex = b.toString(16).padStart(2, '0');
        
        send(`7e000503${rHex}${gHex}${bHex}00ef`);
    }

    $('colorPicker').oninput = updateRGB;

    $('brightness').oninput = function() {
        $('brightnessVal').textContent = this.value;
        const val = parseInt(this.value).toString(16).padStart(2, '0');
        send(`7e0001${val}00000000ef`);
    };
</script>

</body>
</html>
