<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LED Controller Pro</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --primary: #007aff;
            --success: #34c759;
            --error: #ff3b30;
            --text: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
        }

        .card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid #333;
        }

        h2 { text-align: center; margin-top: 0; font-weight: 600; }

        .status-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 14px;
            color: #aaa;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--error);
            margin-right: 8px;
            transition: background 0.3s;
        }

        .status-dot.active { background: var(--success); box-shadow: 0 0 10px var(--success); }

        input {
            width: calc(100% - 24px);
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #444;
            border-radius: 10px;
            background: #2a2a2a;
            color: white;
            font-size: 14px;
        }

        button {
            width: 100%;
            padding: 16px;
            margin: 8px 0;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-connect { background: var(--primary); color: white; }
        .btn-action { background: #333; color: white; opacity: 0.5; }
        .btn-action.enabled { opacity: 1; background: #444; }
        .btn-action.enabled:active { transform: scale(0.96); background: #555; }

        .quick-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }

        .quick-btn {
            padding: 8px 14px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            color: #aaa;
            font-size: 12px;
            cursor: pointer;
        }

        .quick-btn:active { background: #333; }

        #log {
            margin-top: 20px;
            background: #000;
            color: #00ff41;
            padding: 12px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            height: 120px;
            overflow-y: auto;
            border: 1px solid #222;
        }

        .warning {
            background: #410;
            color: #fb0;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            margin-bottom: 15px;
            display: none;
        }

        .info {
            background: #004;
            color: #6cf;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

<div class="card">
    <h2>LED Control</h2>

    <div id="bleWarning" class="warning">
        ‚ö†Ô∏è Bluetooth –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ù–∞ iPhone –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä <b>Bluefy</b> –∏ HTTPS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.
    </div>

    <div class="info">
        üí° –í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–≤—ã–µ –±—É–∫–≤—ã –∏–º–µ–Ω–∏ –≤–∞—à–µ–≥–æ BLE —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "LED", "ELK", "RGB")
    </div>

    <input type="text" id="devicePrefix" placeholder="–ü—Ä–µ—Ñ–∏–∫—Å –∏–º–µ–Ω–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: LED)" value="LED">

    <div class="quick-filters">
        <button class="quick-btn" onclick="setPrefix('LED')">LED</button>
        <button class="quick-btn" onclick="setPrefix('ELK')">ELK</button>
        <button class="quick-btn" onclick="setPrefix('RGB')">RGB</button>
        <button class="quick-btn" onclick="setPrefix('BLE')">BLE</button>
        <button class="quick-btn" onclick="setPrefix('Magic')">Magic</button>
        <button class="quick-btn" onclick="setPrefix('')">–õ—é–±–æ–µ</button>
    </div>

    <div class="status-container">
        <div id="statusDot" class="status-dot"></div>
        <span id="statusText">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</span>
    </div>

    <button class="btn-connect" id="connectBtn">–ù–∞–π—Ç–∏ –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å</button>
    
    <div style="margin: 15px 0; border-top: 1px solid #333;"></div>

    <button class="btn-action" id="cmd1" disabled>–í–∫–ª—é—á–∏—Ç—å (–ö–æ–¥ 1)</button>
    <button class="btn-action" id="cmd2" disabled>–í—ã–∫–ª—é—á–∏—Ç—å (–ö–æ–¥ 2)</button>

    <div id="log">–û–∂–∏–¥–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π...</div>
</div>

<script>
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ UUID
    const SERVICE_UUID = 0xFFF0;
    const CHAR_UUID_MAIN = 'c6fe3e34-f194-4e8a-b1df-c7debbe0e061';
    const CHAR_UUID_FALLBACK = 0xFFF3;

    // –ö–æ–º–∞–Ω–¥—ã
    const HEX_1 = "7e00010a00000000ef";
    const HEX_2 = "7e00013200000000ef";

    let device = null;
    let characteristic = null;

    const logElement = document.getElementById('log');
    const connectBtn = document.getElementById('connectBtn');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const bleWarning = document.getElementById('bleWarning');
    const devicePrefix = document.getElementById('devicePrefix');

    function setPrefix(prefix) {
        devicePrefix.value = prefix;
    }

    function log(msg) {
        const now = new Date();
        const time = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0') + ":" + now.getSeconds().toString().padStart(2, '0');
        logElement.innerHTML += `[${time}] ${msg}<br>`;
        logElement.scrollTop = logElement.scrollHeight;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Bluetooth –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    if (!navigator.bluetooth) {
        bleWarning.style.display = 'block';
        log("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: navigator.bluetooth –Ω–µ –Ω–∞–π–¥–µ–Ω.");
    }

    async function connect() {
        try {
            const prefix = devicePrefix.value.trim();
            log(`–ü–æ–∏—Å–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º "${prefix || '–ª—é–±–æ–µ'}"...`);
            
            // –°–æ–∑–¥–∞—ë–º —Ñ–∏–ª—å—Ç—Ä—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–≤–µ–¥—ë–Ω–Ω–æ–≥–æ –ø—Ä–µ—Ñ–∏–∫—Å–∞
            let requestOptions;
            
            if (prefix) {
                requestOptions = {
                    filters: [{ namePrefix: prefix }],
                    optionalServices: [SERVICE_UUID]
                };
            } else {
                // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —á–µ—Ä–µ–∑ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
                requestOptions = {
                    filters: [
                        { services: [SERVICE_UUID] },
                        { namePrefix: 'LED' },
                        { namePrefix: 'BLE' },
                        { namePrefix: 'RGB' },
                        { namePrefix: 'ELK' },
                        { namePrefix: 'Magic' },
                        { namePrefix: 'ihoment' },
                        { namePrefix: 'Triones' }
                    ],
                    optionalServices: [SERVICE_UUID]
                };
            }

            device = await navigator.bluetooth.requestDevice(requestOptions);

            log(`–ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ "${device.name || '–ë–µ–∑—ã–º—è–Ω–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ'}"...`);
            
            device.addEventListener('gattserverdisconnected', onDisconnected);
            
            const server = await device.gatt.connect();
            log("GATT —Å–µ—Ä–≤–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω.");

            log("–ü–æ–∏—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ FFF0...");
            const service = await server.getPrimaryService(SERVICE_UUID);

            log("–ü–æ–∏—Å–∫ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏...");
            try {
                characteristic = await service.getCharacteristic(CHAR_UUID_MAIN.toLowerCase());
                log("–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –Ω–∞–π–¥–µ–Ω–∞ (–û—Å–Ω–æ–≤–Ω–∞—è).");
            } catch (e) {
                log("–î–ª–∏–Ω–Ω—ã–π ID –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É–µ–º FFF3...");
                characteristic = await service.getCharacteristic(CHAR_UUID_FALLBACK);
                log("–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –Ω–∞–π–¥–µ–Ω–∞ (–ó–∞–ø–∞—Å–Ω–∞—è).");
            }

            // –£—Å–ø–µ—Ö
            statusDot.classList.add('active');
            statusText.innerText = "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ: " + (device.name || "LED");
            connectBtn.innerText = "–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å";
            
            document.getElementById('cmd1').disabled = false;
            document.getElementById('cmd1').classList.add('enabled');
            document.getElementById('cmd2').disabled = false;
            document.getElementById('cmd2').classList.add('enabled');

            log("–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–∞–Ω–¥.");

        } catch (error) {
            log("–û—à–∏–±–∫–∞: " + error.message);
            console.error(error);
        }
    }

    async function sendHex(hex) {
        if (!characteristic) {
            log("–û—à–∏–±–∫–∞: –Ω–µ—Ç —Å–≤—è–∑–∏ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º.");
            return;
        }

        try {
            const bytes = new Uint8Array(hex.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
            await characteristic.writeValue(bytes);
            log("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: " + hex);
        } catch (error) {
            log("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + error.message);
        }
    }

    function onDisconnected() {
        log("–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ.");
        statusDot.classList.remove('active');
        statusText.innerText = "–°–≤—è–∑—å –ø–æ—Ç–µ—Ä—è–Ω–∞";
        document.getElementById('cmd1').disabled = true;
        document.getElementById('cmd1').classList.remove('enabled');
        document.getElementById('cmd2').disabled = true;
        document.getElementById('cmd2').classList.remove('enabled');
    }

    connectBtn.onclick = connect;
    document.getElementById('cmd1').onclick = () => sendHex(HEX_1);
    document.getElementById('cmd2').onclick = () => sendHex(HEX_2);

</script>
</body>
</html>
